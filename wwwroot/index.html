<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Model CRUD Test</title>
    <script src="js/model-service.js"></script>
    <script src="js/model-spec-service.js"></script>
    <style>
        body {
            padding: 20px;
            font-family: Arial, sans-serif;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .crud-panel {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .model-list {
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 8px;
            border: 1px solid #ddd;
            text-align: left;
        }
        th {
            background-color: #f4f4f4;
        }
        button {
            padding: 5px 10px;
            margin: 2px;
            cursor: pointer;
        }
        .success { background-color: #4CAF50; color: white; border: none; }
        .warning { background-color: #ff9800; color: white; border: none; }
        .danger { background-color: #f44336; color: white; border: none; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Model CRUD Test Panel</h1>

        <!-- Create Model Panel -->
        <div class="crud-panel">
            <h2>Create New Model</h2>
            <input type="text" id="modelCode" placeholder="Model Code" />
            <input type="text" id="modelName" placeholder="Model Name" />
            <input type="text" id="description" placeholder="Description" />
            <button onclick="createModel()" class="success">Create Model</button>
        </div>

        <!-- Add Specification Panel -->
        <div class="crud-panel">
            <h2>Add Specification</h2>
            <input type="number" id="modelId" placeholder="Model ID" />
            <input type="text" id="specName" placeholder="Spec Name" />
            <input type="number" id="minValue" placeholder="Min Value" />
            <input type="number" id="maxValue" placeholder="Max Value" />
            <input type="text" id="unit" placeholder="Unit" />
            <input type="number" id="displayOrder" placeholder="Display Order" />
            <button onclick="createSpecification()" class="success">Add Specification</button>
        </div>

        <!-- Model List -->
        <div class="model-list">
            <h2>Models</h2>
            <button onclick="refreshModels()" class="success">Refresh List</button>
            <table id="modelTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Code</th>
                        <th>Name</th>
                        <th>Description</th>
                        <th>Created At</th>
                        <th>Total Products</th>
                        <th>Specifications</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="modelTableBody">
                    <!-- Models will be inserted here -->
                </tbody>
            </table>
        </div>
    </div>

    <script>

        async function createModel() {
            try {
                const modelData = {
                    modelCode: document.getElementById('modelCode').value,
                    modelName: document.getElementById('modelName').value,
                    description: document.getElementById('description').value,
                    createdAt: new Date().toISOString(),
                    totalProducts: 0
                };

                console.log('Attempting to create model with data:', modelData);
                const result = await ModelService.createModel(modelData);
                console.log('Model created successfully:', result);
                await refreshModels();
                clearForm();
            } catch (error) {
                console.error('Error in createModel function:', error);
                alert('Error creating model: ' + (error.message || error));
            }
        }

        async function refreshModels() {
            try {
                const models = await ModelService.getAllModels();
                console.log('Models fetched:', models);
                
                const tbody = document.getElementById('modelTableBody');
                tbody.innerHTML = '';

                for (const model of models) {
                    const specs = await ModelSpecificationService.getSpecifications(model.ModelId);
                    const specsHtml = specs.length > 0 
                        ? specs.map(spec => 
                            `<div>
                                ${spec.SpecName}: ${spec.MinValue}-${spec.MaxValue} ${spec.Unit || ''}
                                <button onclick="deleteSpecification(${spec.SpecId})" class="danger">X</button>
                            </div>`
                        ).join('')
                        : 'No specifications';

                    const row = `
                        <tr>
                            <td>${model.ModelId}</td>
                            <td>${model.ModelCode}</td>
                            <td>${model.ModelName}</td>
                            <td>${model.Description || ''}</td>
                            <td>${new Date(model.CreatedAt).toLocaleString()}</td>
                            <td>${model.TotalProducts}</td>
                            <td>${specsHtml}</td>
                            <td>
                                <button onclick="updateModel(${model.ModelId})" class="warning">Update</button>
                                <button onclick="deleteModel(${model.ModelId})" class="danger">Delete</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                }
            } catch (error) {
                console.error('Error fetching models:', error);
                alert('Error fetching models: ' + error.message);
            }
        }

        async function updateModel(modelId) {
            try {
                const modelCode = document.getElementById('modelCode').value;
                const modelName = document.getElementById('modelName').value;
                const description = document.getElementById('description').value;

                if (!modelCode && !modelName && !description) {
                    alert('Please enter some values in the form to update');
                    return;
                }

                if (!confirm(`Are you sure you want to update Model #${modelId} with these values?`)) {
                    return;
                }

                const model = {
                    ModelId: modelId,
                    ModelCode: modelCode,
                    ModelName: modelName,
                    Description: description
                };

                const result = await ModelService.updateModel(model);
                console.log('Model updated:', result);
                await refreshModels();
                clearForm();
            } catch (error) {
                console.error('Error updating model:', error);
                alert('Error updating model: ' + (error.message || error.error));
            }
        }

        async function deleteModel(modelId) {
            try {
                if (!confirm('Are you sure you want to delete this model?')) return;

                const result = await ModelService.deleteModel(modelId);
                console.log('Model deleted:', result);
                await refreshModels();
            } catch (error) {
                console.error('Error deleting model:', error);
                alert('Error deleting model: ' + error.message);
            }
        }

        function clearForm() {
            document.getElementById('modelCode').value = '';
            document.getElementById('modelName').value = '';
            document.getElementById('description').value = '';
        }

        async function createSpecification() {
            try {
                const modelId = document.getElementById('modelId').value;
                const specName = document.getElementById('specName').value;
                const minValue = document.getElementById('minValue').value;
                const maxValue = document.getElementById('maxValue').value;
                const unit = document.getElementById('unit').value;
                const displayOrder = document.getElementById('displayOrder').value;

                // Validation
                if (!modelId) {
                    throw new Error('Model ID is required');
                }
                if (!specName) {
                    throw new Error('Specification Name is required');
                }
                if (!minValue) {
                    throw new Error('Minimum Value is required');
                }
                if (!maxValue) {
                    throw new Error('Maximum Value is required');
                }
                if (!displayOrder) {
                    throw new Error('Display Order is required');
                }

                const specData = {
                    modelId: parseInt(modelId),
                    specName: specName,
                    minValue: parseFloat(minValue),
                    maxValue: parseFloat(maxValue),
                    unit: unit,
                    displayOrder: parseInt(displayOrder)
                };

                // Validate numeric values
                if (isNaN(specData.modelId)) {
                    throw new Error('Invalid Model ID');
                }
                if (isNaN(specData.minValue)) {
                    throw new Error('Invalid Minimum Value');
                }
                if (isNaN(specData.maxValue)) {
                    throw new Error('Invalid Maximum Value');
                }
                if (isNaN(specData.displayOrder)) {
                    throw new Error('Invalid Display Order');
                }

                // Validate min/max values
                if (specData.minValue >= specData.maxValue) {
                    throw new Error('Minimum Value must be less than Maximum Value');
                }

                console.log('Creating specification with data:', specData);
                const result = await ModelSpecificationService.createSpecification(specData);
                console.log('Specification created successfully:', result);
                clearSpecForm();
                alert('Specification created successfully!');
            } catch (error) {
                console.error('Error creating specification:', error);
                alert('Error creating specification: ' + (error.message || error));
            }
        }

        function clearSpecForm() {
            document.getElementById('modelId').value = '';
            document.getElementById('specName').value = '';
            document.getElementById('minValue').value = '';
            document.getElementById('maxValue').value = '';
            document.getElementById('unit').value = '';
            document.getElementById('displayOrder').value = '';
        }

        // Load models when page loads
        document.addEventListener('DOMContentLoaded', refreshModels);

        async function deleteSpecification(specId) {
            try {
                if (!confirm('Are you sure you want to delete this specification?')) return;

                const result = await ModelSpecificationService.deleteSpecification(specId);
                console.log('Specification deleted:', result);
                await refreshModels();
            } catch (error) {
                console.error('Error deleting specification:', error);
                alert('Error deleting specification: ' + error.message);
            }
        }
    </script>
</body>
</html>