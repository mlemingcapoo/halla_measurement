<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reports - Halla Electronics Vina</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <style>
        .select2-container .select2-selection--single {
            height: 2.5rem !important;
            padding: 0.5rem !important;
            font-weight: 700 !important;
            border-color: #e5e7eb !important;
            border-radius: 0.5rem !important;
            background-color: white !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 1.5 !important;
            color: #111827 !important;
            padding-left: 0 !important;
            padding-right: 0 !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            display: none !important;
        }

        .select2-container--default .select2-selection--single .select2-selection__clear {
            display: none !important;
        }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="../js/model-service.js"></script>
    <script src="../js/model-spec-service.js"></script>
    <script src="../js/product-service.js"></script>
    <script src="../js/product-measurement-service.js"></script>
</head>

<body class="bg-white min-h-screen">
    <!-- Navbar -->
    <nav class="bg-white shadow-lg px-6 py-3 flex items-center justify-between">
        <a href="../index.html" class="flex items-center text-gray-600 hover:text-gray-900 transition-colors">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
            </svg>
            <span class="ml-2 font-medium">Back</span>
        </a>
        <div class="flex items-center space-x-3">
            <img src="../images/logo.png" alt="Halla Electronics Vina" class="h-10">
            <span class="text-gray-900 font-semibold text-lg">HALLA ELECTRONICS VINA</span>
        </div>
        <h1 class="text-2xl font-bold text-orange-600">Reports Dashboard</h1>
        <div class="text-gray-800 font-mono">
            <span id="clock" class="text-lg"></span>
            <div id="date" class="text-sm"></div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mx-auto p-6 space-y-6">
        <!-- Chart Container Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <div class="bg-white p-6 rounded-lg shadow">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold text-center">Product Measurements</h3>
                    <select id="productionTimeFilter" class="p-2 border rounded">
                        <option value="daily">Theo ngày</option>
                        <option value="weekly">Theo tuần</option>
                        <option value="monthly">Theo tháng</option>
                    </select>
                </div>
                <div style="height: 400px;">
                    <canvas id="productionChart"></canvas>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-4 text-center">Defect Rate</h3>
                <canvas id="qualityChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-4 text-center">Efficiency Analysis</h3>
                <canvas id="efficiencyChart"></canvas>
            </div>
            <div class="bg-white p-6 rounded-lg shadow">
                <h3 class="text-lg font-semibold mb-4 text-center">Resource Utilization</h3>
                <canvas id="resourceChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // Initialize clock
        function updateClock() {
            const now = new Date();
            $('#clock').text(now.toLocaleTimeString());
            $('#date').text(now.toLocaleDateString());
        }
        setInterval(updateClock, 1000);
        updateClock();

        // Initialize Select2
        $(document).ready(function () {
            $('#productionTimeFilter').select2();
        });

        // Chart configurations and initialization
        const chartConfigs = {
            production: {
                type: 'bar',
                data: {
                    labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                    datasets: [
                        {
                            label: 'OK',
                            data: [150, 142, 160, 145, 155, 140, 148],
                            backgroundColor: 'rgba(59, 130, 246, 0.8)',
                            borderColor: 'rgb(59, 130, 246)',
                            borderWidth: 1
                        },
                        {
                            label: 'NG',
                            data: [12, 15, 10, 8, 14, 11, 13],
                            backgroundColor: 'rgba(249, 115, 22, 0.8)',
                            borderColor: 'rgb(249, 115, 22)',
                            borderWidth: 1
                        }
                    ]
                }
            },
            quality: {
                type: 'line',
                data: {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [{
                        label: 'Defect Rate (%)',
                        data: [2.1, 1.8, 1.5, 1.9, 1.2, 1.0],
                        borderColor: 'rgba(255, 99, 132, 1)',
                        tension: 0.4,
                        fill: false
                    }]
                }
            },
            efficiency: {
                type: 'pie',
                data: {
                    labels: ['Active', 'Idle', 'Maintenance', 'Setup'],
                    datasets: [{
                        data: [65, 15, 12, 8],
                        backgroundColor: [
                            'rgba(75, 192, 192, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(153, 102, 255, 0.2)',
                            'rgba(255, 159, 64, 0.2)'
                        ],
                        borderColor: [
                            'rgba(75, 192, 192, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(153, 102, 255, 1)',
                            'rgba(255, 159, 64, 1)'
                        ],
                        borderWidth: 1
                    }]
                }
            },
            resource: {
                type: 'doughnut',
                data: {
                    labels: ['Labor', 'Materials', 'Energy', 'Other'],
                    datasets: [{
                        data: [40, 35, 15, 10],
                        backgroundColor: [
                            'rgba(255, 99, 132, 0.2)',
                            'rgba(54, 162, 235, 0.2)',
                            'rgba(255, 206, 86, 0.2)',
                            'rgba(75, 192, 192, 0.2)'
                        ],
                        borderColor: [
                            'rgba(255, 99, 132, 1)',
                            'rgba(54, 162, 235, 1)',
                            'rgba(255, 206, 86, 1)',
                            'rgba(75, 192, 192, 1)'
                        ],
                        borderWidth: 1
                    }]
                }
            }
        };

        // Initialize charts
        const charts = {};
        Object.entries(chartConfigs).forEach(([key, config]) => {
            const ctx = document.getElementById(`${key}Chart`).getContext('2d');
            charts[key] = new Chart(ctx, {
                type: config.type,
                data: config.data,
                options: {
                    responsive: true,
                    maintainAspectRatio: key === 'production' ? false : true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    scales: (config.type === 'bar' || config.type === 'line') ? {
                        y: {
                            beginAtZero: true
                        }
                    } : undefined
                }
            });
        });

        // Add these functions after the chartConfigs definition
        async function getProductData(timeFilter) {
            try {
                const models = await ModelService.getAllModels();
                let allProducts = [];

                // Fetch products for all models
                for (const model of models) {
                    const products = await ProductService.getProductsByModelId(model.ModelId);
                    const specs = await ModelSpecificationService.getSpecifications(model.ModelId);

                    // Enhance products with OK/NG status
                    products.forEach(product => {
                        const isOK = product.Measurements.every(measurement => {
                            const spec = specs.find(s => s.SpecId === measurement.SpecId);
                            return measurement.Value >= spec.MinValue && measurement.Value <= spec.MaxValue;
                        });
                        product.status = isOK ? 'OK' : 'NG';
                    });

                    allProducts = [...allProducts, ...products];
                }

                // Sort products by date
                allProducts.sort((a, b) => new Date(a.MeasurementDate) - new Date(b.MeasurementDate));

                // Group products based on time filter
                const now = new Date();
                const timeData = { labels: [], ok: [], ng: [] };

                switch (timeFilter) {
                    case 'daily':
                        // Last 7 days
                        for (let i = 6; i >= 0; i--) {
                            const date = new Date(now);
                            date.setDate(date.getDate() - i);
                            const dayStr = date.toLocaleDateString('vi-VN', { weekday: 'short' });

                            const dayProducts = allProducts.filter(p =>
                                new Date(p.MeasurementDate).toDateString() === date.toDateString()
                            );

                            timeData.labels.push(dayStr);
                            timeData.ok.push(dayProducts.filter(p => p.status === 'OK').length);
                            timeData.ng.push(dayProducts.filter(p => p.status === 'NG').length);
                        }
                        break;

                    case 'weekly':
                        // Last 4 weeks
                        for (let i = 3; i >= 0; i--) {
                            const weekStart = new Date(now);
                            weekStart.setDate(weekStart.getDate() - (i * 7));
                            const weekEnd = new Date(weekStart);
                            weekEnd.setDate(weekEnd.getDate() + 6);

                            console.log(`Week ${4 - i}:`, {
                                start: weekStart.toISOString(),
                                end: weekEnd.toISOString()
                            });

                            const weekProducts = allProducts.filter(p => {
                                const date = new Date(p.MeasurementDate);
                                date.setHours(0, 0, 0, 0);
                                weekStart.setHours(0, 0, 0, 0);
                                weekEnd.setHours(23, 59, 59, 999);

                                return date >= weekStart && date <= weekEnd;
                            });

                            console.log(`Week ${4 - i} products:`, weekProducts.length);

                            timeData.labels.push(`Tuần ${4 - i}`);
                            timeData.ok.push(weekProducts.filter(p => p.status === 'OK').length);
                            timeData.ng.push(weekProducts.filter(p => p.status === 'NG').length);
                        }
                        break;

                    case 'monthly':
                        // Last 6 months
                        for (let i = 5; i >= 0; i--) {
                            const date = new Date(now);
                            date.setMonth(date.getMonth() - i);
                            const monthStr = date.toLocaleDateString('vi-VN', { month: 'short' });

                            const monthProducts = allProducts.filter(p => {
                                const prodDate = new Date(p.MeasurementDate);
                                return prodDate.getMonth() === date.getMonth() &&
                                    prodDate.getFullYear() === date.getFullYear();
                            });

                            timeData.labels.push(monthStr);
                            timeData.ok.push(monthProducts.filter(p => p.status === 'OK').length);
                            timeData.ng.push(monthProducts.filter(p => p.status === 'NG').length);
                        }
                        break;
                }

                return timeData;
            } catch (error) {
                console.error('Error fetching product data:', error);
                return null;
            }
        }

        // Replace the production time filter handler with this:
        $('#productionTimeFilter').on('change', async function (e) {
            const timeFilter = e.target.value;
            const timeData = await getProductData(timeFilter);

            if (timeData) {
                charts.production.data.labels = timeData.labels;
                charts.production.data.datasets[0].data = timeData.ok;
                charts.production.data.datasets[1].data = timeData.ng;
                charts.production.update();
            }
        });

        // Add initial data load
        document.addEventListener('DOMContentLoaded', async () => {
            const initialTimeData = await getProductData('daily');
            if (initialTimeData) {
                charts.production.data.labels = initialTimeData.labels;
                charts.production.data.datasets[0].data = initialTimeData.ok;
                charts.production.data.datasets[1].data = initialTimeData.ng;
                charts.production.update();
            }
        });
    </script>
</body>

</html>