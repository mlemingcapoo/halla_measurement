<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script>
    // Configure PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>

<div class="text-gray-900">
    <!-- Header Section -->
    <div class="border-b pb-4 mb-4">
        <p class="text-gray-600 font-semibold" id="measurement-start-text">(Checking... please wait) Đang kiểm tra kết nối tới thiết bị đo...</p>
    </div>

    <!-- Main Content Grid -->
    <div class="grid grid-cols-12 gap-4">
        <!-- Left Side: Images (60% width) -->
        <div class="col-span-7 space-y-4">
            <!-- PDF Viewer Container -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <div id="pdf-viewer" class="relative">
                    <!-- PDF Controls -->
                    <div class="flex justify-between items-center mb-4 bg-white p-2 rounded-lg shadow">
                        <div class="flex items-center space-x-2">
                            <button id="prev-page" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50">
                                Previous
                            </button>
                            <span>Page <span id="page-num">0</span> of <span id="page-count">0</span></span>
                            <button id="next-page" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 disabled:opacity-50">
                                Next
                            </button>
                        </div>
                        <div>
                            <select id="pdf-zoom" class="px-2 py-1 border rounded">
                                <option value="0.5">50%</option>
                                <option value="0.75">75%</option>
                                <option value="1" selected>100%</option>
                                <option value="1.25">125%</option>
                                <option value="1.5">150%</option>
                                <option value="2">200%</option>
                            </select>
                        </div>
                    </div>
                    <!-- PDF Canvas Container -->
                    <div id="pdf-container" class="overflow-auto bg-gray-100 rounded-lg" style="height: calc(80vh - 150px);">
                        <canvas id="pdf-canvas" class="mx-auto"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Side: Measurement Info (40% width) -->
        <div class="col-span-5 space-y-4">
            <!-- Top Row: Measurement Progress Table -->
            <div class="bg-gray-50 p-4 rounded-lg">
                <h4 class="text-lg font-semibold mb-2">Tiến độ đo đạc</h4>
                <div class="overflow-x-auto overflow-scroll" style="max-height: 25vh;">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase w-[80px] max-w-[80px]">SPEC</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">Dimen</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">MIN-MAX</th>
                                <th class="px-3 py-2 text-left text-xs font-medium text-gray-500 uppercase">RESULT</th>
                            </tr>
                        </thead>
                        <tbody id="measurement-progress" class="bg-white divide-y divide-gray-200">
                            <!-- Progress rows will be populated dynamically -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Bottom Row: Current Measurement Info -->
            <div id="measurement-prompt" class="bg-gray-50 p-4 rounded-lg text-center hidden">
                <div id="equipment-message" class="bg-blue-100 text-blue-800 p-3 rounded-lg mb-4 text-center">
                    <p class="font-medium">EQUIP: <span id="equipment-name" class="font-bold"></span></p>
                </div>
                <h4 class="text-lg font-semibold mb-2">Dimen: <span class="font-bold" id="current-spec-name">Length</span></h4>
                <div class="text-3xl font-bold text-blue-600 mb-4">
                    <span id="countdown-text" style="font-size: 1.2rem;">Waiting...</span>
                    <span id="countdown" class="hidden">Waiting...</span>
                </div>
                
                <!-- Add manual input section -->
                <div class="flex items-center justify-center space-x-2 mb-4">
                    <input type="number" 
                        id="manual-measurement" 
                        class="px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 w-32 text-center"
                        placeholder="Manual value"
                        step="0.001">
                    <button id="submit-manual" 
                        class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors">
                        OK
                    </button>
                </div>

                <div class="mb-4">
                    <div id="measurement-value" class="text-2xl font-bold">--</div>
                </div>
                <div id="measurement-buttons" class="flex justify-center space-x-4">
                    <button type="button" id="remeasure-prev-spec"
                        class="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors hidden">
                        <div class="text-sm">Đo Lại TS trước đó</div>
                        <div class="text-xs">(Space)</div>
                    </button>
                </div>
            </div>

            <!-- Start Button -->
            <div id="start-container" class="text-center hidden">
                <button type="button" id="start-measuring" disabled
                    class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors">
                    Bắt đầu
                </button>
            </div>
        </div>
    </div>

    <!-- Continue Dialog -->
    <div id="continue-dialog" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h4 class="text-lg font-bold mb-4">Đã đo xong sản phẩm (Done measurement)</h4>
            
            <div id="measurements-summary" class="mb-4 max-h-[50vh] overflow-auto">
                <!-- Summary will be populated dynamically -->
            </div>
            
            <p class="mb-4">Tiếp tục đo sản phẩm khác? (Continue?)</p>
            <div class="flex justify-end space-x-3">
                <button type="button" id="start-over"
                    class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
                    <div>Đo Lại</div>
                    <div>(Start Over)</div>
                </button>
                <button type="button" id="cancel-measuring"
                    class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                    <div>Lưu và Thoát</div>
                    <div>(Save and Exit)</div>
                </button>
                <button type="button" id="continue-measuring"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <div>Lưu và Tiếp Tục</div>
                    <div>(Save and Continue)</div>
                </button>
            </div>
        </div>
    </div>

    <div id="product-selection-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-6 w-full max-w-lg">
            <h3 class="text-lg font-bold mb-4">Select Product to Complete CNC Measurements</h3>
            <div class="max-h-96 overflow-y-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead>
                        <tr>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Mold Number
                            </th>
                            <th class="px-6 py-3 bg-gray-50 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Measurement Date
                            </th>
                            <th class="px-6 py-3 bg-gray-50"></th>
                        </tr>
                    </thead>
                    <tbody id="incomplete-products-list" class="bg-white divide-y divide-gray-200">
                        <!-- Products will be inserted here -->
                    </tbody>
                </table>
            </div>
            <div class="mt-4 flex justify-end">
                <button onclick="closeProductSelectionModal()" 
                        class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg mr-2">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Mold Number Input Modal -->
    <div id="mold-number-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h4 class="text-lg font-bold mb-4">Nhập Mold Number</h4>
            
            <div class="mb-4">
                <label for="modal-mold-number" class="block text-sm font-medium text-gray-700 mb-1">
                    Mold Number <span class="text-red-500">*</span>
                </label>
                <input type="text" 
                    id="modal-mold-number" 
                    class="w-full px-3 py-2 border rounded-lg focus:ring-blue-500 focus:border-blue-500 transition-colors"
                    placeholder="Enter mold number">
                <p id="modal-mold-number-error" class="mt-1 text-sm text-red-600 hidden">
                    Please enter mold number
                </p>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button type="button" id="modal-mold-cancel"
                    class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                    <div>Hủy</div>
                    <div>(Cancel)</div>
                </button>
                <button type="button" id="modal-mold-confirm"
                    class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <div>Xác nhận (Enter)</div>
                    <div>(Confirm)</div>
                </button>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div id="image-preview-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="relative max-w-4xl w-full mx-4">
            <!-- Close button -->
            <button type="button" id="close-preview" class="absolute top-0 right-0 -mt-12 text-white hover:text-gray-300">
                <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
            <!-- Image container -->
            <div class="bg-white rounded-lg p-2 overflow-hidden">
                <img id="preview-image" src="" alt="Preview" 
                    class="w-full h-auto max-h-[80vh] object-contain rounded select-none transition-transform duration-100"
                    style="transform-origin: center center; cursor: default;"
                    draggable="false">
            </div>
            <!-- Zoom instructions -->
            <div class="absolute bottom-0 left-1/2 transform -translate-x-1/2 -mb-8 text-white text-sm bg-black bg-opacity-50 px-3 py-1 rounded-full">
                Use mouse wheel to zoom • Click and drag to pan
            </div>
        </div>
    </div>
</div>
<!-- <script src="./js/PopupUtil.js"></script> -->
<!-- Move PDF.js scripts to the top, before any other scripts -->

<script>
    // Set worker path
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
</script>
<script>
    async function ensureServicesLoaded() {
        console.log('Checking required services...');

        // Create a global tracker for service loading
        window._serviceLoadingPromises = window._serviceLoadingPromises || {};

        async function loadService(name, path) {
            // If service is already loaded, return immediately
            if (window[name]) {
                console.log(`${name} already loaded`);
                return;
            }

            // If service is currently loading, wait for it
            if (window._serviceLoadingPromises[name]) {
                console.log(`Waiting for ${name} to load...`);
                return window._serviceLoadingPromises[name];
            }

            // Start loading the service
            console.log(`Loading ${name}...`);
            window._serviceLoadingPromises[name] = new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = path;
                script.onload = () => {
                    console.log(`${name} loaded successfully`);
                    delete window._serviceLoadingPromises[name];
                    resolve();
                };
                script.onerror = (error) => {
                    console.error(`Failed to load ${name}:`, error);
                    delete window._serviceLoadingPromises[name];
                    reject(error);
                };
                document.head.appendChild(script);
            });

            return window._serviceLoadingPromises[name];
        }

        try {
            await loadService('ModelSpecificationService', './js/model-spec-service.js');
            await loadService('ProductSpecificationService', './js/product-measurement-service.js');
        } catch (error) {
            console.error('Error loading services:', error);
            throw error;
        }
    }

    // Add this before the MeasurementProcess class
    // function showToast(message, type = 'success') {
    //     // Create toast container if it doesn't exist
    //     let container = document.getElementById('toast-container');
    //     if (!container) {
    //         container = document.createElement('div');
    //         container.id = 'toast-container';
    //         container.className = 'fixed top-4 right-4 z-50 flex flex-col gap-2';
    //         document.body.appendChild(container);
    //     }

    //     // Create toast element
    //     const toast = document.createElement('div');

    //     const baseClasses = 'flex items-center p-4 mb-4 rounded-lg shadow-lg transition-all duration-500 transform translate-x-full';
    //     const typeClasses = type === 'success'
    //         ? 'text-green-800 bg-green-50'
    //         : 'text-red-800 bg-red-50';

    //     toast.className = `${baseClasses} ${typeClasses}`;
    //     toast.innerHTML = `
    //     <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
    //         ${type === 'success'
    //             ? '<path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>'
    //             : '<path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>'
    //         }
    //     </svg>
    //     <span class="text-sm font-semibold">${message}</span>
    // `;

    //     container.appendChild(toast);

    //     // Animate in
    //     setTimeout(() => toast.classList.remove('translate-x-full'), 10);

    //     // Remove after 3 seconds
    //     setTimeout(() => {
    //         toast.classList.add('translate-x-full');
    //         setTimeout(() => container.removeChild(toast), 500);
    //     }, 3000);
    // }

    console.log('Modal script starting to load');

    // Initialize only if services are available
    if (window.services && window.services.initialized) {
        if (!window.measurementForm) {
            window.measurementForm = new MeasurementProcess();
        } else {
            // Reinitialize the existing instance
            window.measurementForm.initialize();
        }
    }
</script>